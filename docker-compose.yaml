services:
  kafka:
    image: 'bitnami/kafka:latest'
    container_name: kafka
    ports:
      - "29092:9092"
    volumes:
      - kafka_data:/bitnami/kafka
      - ./kafka-entrypoint.sh:/entrypoint-custom.sh
    entrypoint: /entrypoint-custom.sh
    environment:
      # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–∞ KRaft ---
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - ALLOW_PLAINTEXT_LISTENER=yes

      # --- –ü–∞—Ä–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è Kafka ---
      # –ö–û–õ–ò–ß–ï–°–¢–í–û –ü–ê–†–¢–ò–¶–ò–ô.
      # –ë–æ–ª—å—à–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
      # - KAFKA_CFG_NUM_PARTITIONS=3

      # –í–†–ï–ú–Ø –•–†–ê–ù–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
      # –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–ø–∏–∫–µ –¥–æ –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è.
      # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - 7 –¥–Ω–µ–π (604800000 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥). -1 –æ–∑–Ω–∞—á–∞–µ—Ç "—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—á–Ω–æ".
      # –ü—Ä–∏–º–µ—Ä: 1 —á–∞—Å (3600000)
      # - KAFKA_CFG_LOG_RETENTION_MS=3600000

    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s

  postgres: 
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_DB: events_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres_init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d events_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  event-emitter:
    build: ./emitter
    container_name: event-emitter
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      # –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –ª—é–±—É—é –∂–µ–ª–∞–µ–º—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
      - MESSAGES_PER_SECOND=1000
      
      # --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–û–î–Æ–°–ï–†–ê ---
      # –£–†–û–í–ï–ù–¨ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
      # –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏.
      # '0': –Ω–µ –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–æ –µ—Å—Ç—å —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π).
      # '1': –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –æ—Ç –ª–∏–¥–µ—Ä–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ (—Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
      # 'all': –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç –≤—Å–µ—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–ø–ª–∏–∫ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å).
      # - PRODUCER_ACKS=1

      # –†–ê–ó–ú–ï–† –ü–ê–ß–ö–ò (–≤ –±–∞–π—Ç–∞—Ö)
      # –ü—Ä–æ–¥—é—Å–µ—Ä –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.
      # –ë–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä = –≤—ã—à–µ –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –Ω–æ –≤—ã—à–µ –∏ –∑–∞–¥–µ—Ä–∂–∫–∞.
      # - PRODUCER_BATCH_SIZE=4096 # (—ç—Ç–æ 4 –ö–ë)

      # –í–†–ï–ú–Ø –û–ñ–ò–î–ê–ù–ò–Ø (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
      # –ö–∞–∫ –¥–æ–ª–≥–æ –∂–¥–∞—Ç—å, —á—Ç–æ–±—ã –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –ø–∞—á–∫—É.
      # –ó–Ω–∞—á–µ–Ω–∏–µ > 0 —Å–∏–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.
      # - PRODUCER_LINGER_MS=5
  kafka-consumer:
    build: ./kafka_consumer
    container_name: kafka-consumer
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      # –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
      POSTGRES_HOST: postgres
      POSTGRES_DB: events_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      # --- –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–ù–°–¨–Æ–ú–ï–†–ê ---

      # üé¨ –°–¢–ê–†–¢–û–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø
      # 'earliest': —á–∏—Ç–∞—Ç—å —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ —Ç–æ–ø–∏–∫–∞.
      # 'latest': —á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞.
      # - AUTO_OFFSET_RESET=earliest

      # üì¶ –†–ê–ó–ú–ï–† –ü–ê–ß–ö–ò (–≤ –∑–∞–ø–∏—Å—è—Ö)
      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–ª—É—á–∞–µ–º—ã—Ö –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑.
      # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏.
      # - MAX_POLL_RECORDS=500

      # ‚öñÔ∏è –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –û–ë–™–ï–ú –î–ê–ù–ù–´–• (–≤ –±–∞–π—Ç–∞—Ö)
      # –ë—Ä–æ–∫–µ—Ä –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –Ω–∞–±–µ—Ä–µ—Ç—Å—è —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö,
      # –ø—Ä–µ–∂–¥–µ —á–µ–º –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è. –£–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ç—å.
      # - FETCH_MIN_BYTES=1

volumes:
  kafka_data:
  postgres_data: